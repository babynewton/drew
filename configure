#!/bin/bash

#The MIT License (MIT)
#
#Copyright (c) 2013 drew
#
#Permission is hereby granted, free of charge, to any person obtaining a copy of
#this software and associated documentation files (the "Software"), to deal in
#the Software without restriction, including without limitation the rights to
#use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
#the Software, and to permit persons to whom the Software is furnished to do so,
#subject to the following conditions:
#
#The above copyright notice and this permission notice shall be included in all
#copies or substantial portions of the Software.
#
#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
#FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
#COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
#IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
#CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

MK=Makefile
MK_IN=$MK.in

LIBLUA=lua5.1

PREFIX=/usr/local
INST_BIN=/bin

DEVS="lintian fakeroot dpkg-dev libluajit-5.1-dev liblua5.1-0-dev "

PACKAGE_NAME=drew
PACKAGE_VERSION=0.1
DML_VERSION=0.1

PACKAGE_ROOT_DIR=/dist
HOST_ARCH=`dpkg-architecture -qDEB_HOST_ARCH`
HOST_OS=`grep DISTRIB_ID /etc/lsb-release | sed 's/DISTRIB_ID=//'`
HOST_OS_VERSION=`grep DISTRIB_RELEASE /etc/lsb-release | sed 's/DISTRIB_RELEASE=//'`
DEBIAN_PACKAGE=$PACKAGE_NAME-v$PACKAGE_VERSION-$HOST_OS-$HOST_OS_VERSION-$HOST_ARCH.deb
PACKAGE_DEPENDS="libgtk2.0-0"

function config_tools(){
	GTK_DEV=`apt-cache search libgtk2.0-0-dev`
	if [ -n "$GTK_DEV" ]
	then
		DEVS+="libgtk2.0-0-dev"
	else
		DEVS+="libgtk2.0-dev"
	fi
	for DEV in $DEVS
	do
		EXISTS=`dpkg -l | grep $DEV`
		if [ ! -n "$EXISTS" ]
		then
			echo installing $DEV
			sudo apt-get install $DEV
		else
			echo $DEV exists. skip....
		fi
	done
}

function init_luajit(){
	SCRIPT_INCS=`pkg-config --cflags luajit`
	echo luajit includes : $SCRIPT_INCS
	SCRIPT_LIBSS=`pkg-config --libs luajit`
	echo luajit libraries : $SCRIPT_LIBSS
}

function init_lua(){
	SCRIPT_INCS=`pkg-config --cflags lua5.1`
	echo lua includes : $SCRIPT_INCS
	SCRIPT_LIBSS=`pkg-config --libs lua5.1`
	echo lua libraries : $SCRIPT_LIBSS
}

function init_gtk(){
	UI_INCS=`pkg-config --cflags gtk+-2.0`
	echo gtk includes : $UI_INCS
	UI_LIBS=`pkg-config --libs gtk+-2.0`
	echo gtk libraries : $UI_LIBS
}

function config_runner(){
	sed "s#@script_libs@#$SCRIPT_LIBSS#g;
		s#@pkg_root@#$PWD$PACKAGE_ROOT_DIR#g;
		s#@root@#$PREFIX#g;
		s#@bin@#$INST_BIN#g;
		s#@ui_libs@#$UI_LIBS#g"< runner/$MK_IN > runner/$MK
	echo "runner:$MK_IN ==> $MK"
}

function config_script(){
	sed "s#@script_incs@#$SCRIPT_INCS#g" < script/$MK_IN > script/$MK
	echo "engine:$MK_IN ==> $MK"
}

function config_engine(){
	sed "s#@ui_incs@#-I$UI_INCS#g" < engine/$MK_IN > engine/$MK
	echo "engine:$MK_IN ==> $MK"
}

function config_main(){
	sed "s#@debian_package@#$DEBIAN_PACKAGE#g;
		s#@pkg_root@#$PWD$PACKAGE_ROOT_DIR#g;" < $MK_IN > $MK
	echo "$MK_IN ==> $MK"
}

function config_deb(){
	sed "s#@package@#$PACKAGE_NAME#g;
		s#@version@#$PACKAGE_VERSION#g;
		s#@arch@#$HOST_ARCH#g;
		s#@depends@#$PACKAGE_DEPENDS#g;" < toolbox/debian/control.in > toolbox/debian/control
}

function config_header(){
	sed "s#@version@#$PACKAGE_VERSION#g;
		s#@dml_version@#$DML_VERSION#g;
		s#@name@#$PACKAGE_NAME#g;
		s#@arch@#$HOST_ARCH#g;" < config.h.in > config.h
}

function show_help(){
	echo "configure [options]"
	echo "-h, --help	show help screen(this screen)"
	echo "--with-lua	force to use lua instead of luajit"
}

for ARG in $@
do
	if [ "$ARG" == "--help" -o "$ARG" == "-h" ]
	then
		show_help
		exit 0
	elif [ "$ARG" == "--with-lua" ]
	then
		SCRIPT_ENGINE=lua
	fi
done

config_tools

for DIR in dml utility
do
	cd $DIR
	echo "$DIR:$MK_IN ==> $MK"
	cp $MK_IN $MK
	cd ..
done

if [ "$SCRIPT_ENGINE" == "lua" ]
then
	init_lua
	PACKAGE_DEPENDS+=",liblua5.1-0"
else
	init_luajit
	if [ ! -n "$SCRIPT_INCS" ]
	then
		init_lua
		PACKAGE_DEPENDS+=",liblua5.1-0"
	else
		PACKAGE_DEPENDS+=",libluajit5.1-2"
	fi
fi
init_gtk
config_header
config_runner
config_engine
config_script
config_main
config_deb
